name: Backfill Analytics (One-Time)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "BACKFILL" to confirm'
        required: true
        default: ''

jobs:
  backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    # Safety check
    if: github.event.inputs.confirm == 'BACKFILL'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth pytz

      - name: Make tmp folder
        run: |
          mkdir -p tmp
          chmod -R 777 tmp

      - name: Run backfill script
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        run: python .github/scripts/backfill_analytics.py

      - name: Generate initial recommendations
        run: python .github/scripts/track_performance.py

      - name: Upload backfill results
        uses: actions/upload-artifact@v4
        with:
          name: backfill-results
          path: |
            tmp/content_performance.json
            tmp/schedule_recommendations.json
          retention-days: 90

      - name: Save to cache
        uses: actions/cache/save@v4
        with:
          path: |
            tmp/content_performance.json
            tmp/schedule_recommendations.json
          key: performance-data-${{ github.run_number }}  # â† FIXED: Unified cache key

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Backfill Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your existing videos have been analyzed with unified data structure." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f tmp/content_performance.json ]; then
            echo "### ðŸ“Š Performance by Content Type" >> $GITHUB_STEP_SUMMARY
            if command -v jq &> /dev/null; then
              for type in $(jq -r 'keys[]' tmp/content_performance.json); do
                AVG=$(jq -r ".[\"$type\"].average_completion // 0" tmp/content_performance.json)
                TOTAL=$(jq -r ".[\"$type\"].total_uploads // 0" tmp/content_performance.json)
                REWATCH=$(jq -r ".[\"$type\"].average_rewatch // 0" tmp/content_performance.json)
                echo "- **$type**: ${AVG}% completion, ${REWATCH}x rewatch ($TOTAL videos)" >> $GITHUB_STEP_SUMMARY
              done
            fi
          fi
          
          if [ -f tmp/schedule_recommendations.json ]; then
            RECS=$(jq -r '.pending_recommendations | length' tmp/schedule_recommendations.json 2>/dev/null || echo "0")
            if [ "$RECS" != "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ’¡ Recommendations Generated" >> $GITHUB_STEP_SUMMARY
              echo "$RECS schedule recommendations are ready for review!" >> $GITHUB_STEP_SUMMARY
            fi
          fi